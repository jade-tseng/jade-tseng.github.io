<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Spotify Integration Test</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
    .pass { color: green; }
    .fail { color: red; }
    .info { color: blue; }
    iframe { width: 100%; height: 400px; border: 1px solid #ddd; margin: 10px 0; }
    button { padding: 10px 15px; margin: 5px; }
    #results { background: #f5f5f5; padding: 10px; margin: 10px 0; }
  </style>
</head>
<body>

<h1>üß™ Spotify Integration Test Suite</h1>

<div class="test-section">
  <h2>Test 1: Check if music-chart.html loads</h2>
  <button onclick="testChartLoad()">Test Chart Loading</button>
  <iframe id="chartFrame" src="music-chart.html"></iframe>
  <div id="chartResults"></div>
</div>

<div class="test-section">
  <h2>Test 2: Check if Spotify Track IDs are present</h2>
  <button onclick="testTrackIds()">Test Track IDs</button>
  <div id="trackResults"></div>
</div>

<div class="test-section">
  <h2>Test 3: Test Spotify API Token</h2>
  <button onclick="testSpotifyToken()">Test Spotify Token</button>
  <div id="tokenResults"></div>
</div>

<div class="test-section">
  <h2>Test 4: Test Plotly Hover Events</h2>
  <button onclick="testHoverEvents()">Test Hover Events</button>
  <div id="hoverResults"></div>
</div>

<div class="test-section">
  <h2>Test 5: Test Complete Integration</h2>
  <button onclick="testFullIntegration()">Test Full Integration</button>
  <div id="integrationResults"></div>
</div>

<div id="results">
  <h3>üìã Test Results:</h3>
  <div id="output"></div>
</div>

<script>
// Spotify API credentials (same as in music-wrapper.html)
const CLIENT_ID = '44dd5c1f9fa4405c92e27a9fa236e124';
const CLIENT_SECRET = '85ab203ffe05451c8e81cc66e3ef1087';

let spotifyToken = null;
let tokenExpiry = null;

function log(message, type = 'info') {
  const output = document.getElementById('output');
  const timestamp = new Date().toLocaleTimeString();
  const className = type === 'pass' ? 'pass' : type === 'fail' ? 'fail' : 'info';
  output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
  console.log(`[${timestamp}] ${message}`);
}

// Get Spotify access token (same logic as music-wrapper.html)
async function getSpotifyToken() {
  if (spotifyToken && tokenExpiry && Date.now() < tokenExpiry) {
    return spotifyToken;
  }

  try {
    const response = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': 'Basic ' + btoa(CLIENT_ID + ':' + CLIENT_SECRET)
      },
      body: 'grant_type=client_credentials'
    });

    if (!response.ok) {
      throw new Error('Failed to get Spotify token');
    }

    const data = await response.json();
    spotifyToken = data.access_token;
    tokenExpiry = Date.now() + (data.expires_in * 1000) - 60000;
    
    return spotifyToken;
  } catch (error) {
    console.error('Error getting Spotify token:', error);
    return null;
  }
}

// Test 1: Check if music-chart.html loads
function testChartLoad() {
  log('üîç Testing if music-chart.html loads...');
  const iframe = document.getElementById('chartFrame');
  const results = document.getElementById('chartResults');
  
  iframe.onload = function() {
    try {
      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
      if (iframeDoc && iframeDoc.body) {
        log('‚úÖ music-chart.html loaded successfully', 'pass');
        results.innerHTML = '<span class="pass">‚úÖ Chart loads correctly</span>';
        
        // Check if Plotly div exists
        const plotDiv = iframeDoc.querySelector('#plot');
        if (plotDiv) {
          log('‚úÖ Plot div (#plot) found in chart', 'pass');
        } else {
          log('‚ùå Plot div (#plot) NOT found in chart', 'fail');
        }
      } else {
        log('‚ùå Cannot access iframe content - CORS issue?', 'fail');
        results.innerHTML = '<span class="fail">‚ùå Cannot access iframe content</span>';
      }
    } catch (error) {
      log(`‚ùå Error accessing iframe: ${error.message}`, 'fail');
      results.innerHTML = '<span class="fail">‚ùå Error accessing iframe</span>';
    }
  };
  
  iframe.onerror = function() {
    log('‚ùå Failed to load music-chart.html', 'fail');
    results.innerHTML = '<span class="fail">‚ùå Failed to load chart</span>';
  };
}

// Test 2: Check if Spotify Track IDs are present
function testTrackIds() {
  log('üîç Testing Spotify Track IDs...');
  const results = document.getElementById('trackResults');
  const iframe = document.getElementById('chartFrame');
  
  try {
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    const scripts = iframeDoc.querySelectorAll('script');
    
    let foundTrackIds = [];
    scripts.forEach(script => {
      const content = script.textContent || script.innerHTML;
      // Look for Spotify track ID patterns (22 character alphanumeric strings)
      const trackIdMatches = content.match(/[a-zA-Z0-9]{22}/g);
      if (trackIdMatches) {
        foundTrackIds = foundTrackIds.concat(trackIdMatches);
      }
    });
    
    if (foundTrackIds.length > 0) {
      log(`‚úÖ Found ${foundTrackIds.length} potential Spotify Track IDs`, 'pass');
      log(`Track IDs: ${foundTrackIds.slice(0, 5).join(', ')}...`, 'info');
      results.innerHTML = `<span class="pass">‚úÖ Found ${foundTrackIds.length} Track IDs</span>`;
    } else {
      log('‚ùå No Spotify Track IDs found in chart', 'fail');
      results.innerHTML = '<span class="fail">‚ùå No Track IDs found</span>';
    }
  } catch (error) {
    log(`‚ùå Error checking Track IDs: ${error.message}`, 'fail');
    results.innerHTML = '<span class="fail">‚ùå Error checking Track IDs</span>';
  }
}

// Test 3: Test Spotify API Token
async function testSpotifyToken() {
  log('üîç Testing Spotify API token...');
  const results = document.getElementById('tokenResults');
  
  try {
    const token = await getSpotifyToken();
    if (token) {
      log('‚úÖ Successfully obtained Spotify token', 'pass');
      log(`Token starts with: ${token.substring(0, 20)}...`, 'info');
      results.innerHTML = '<span class="pass">‚úÖ Spotify token obtained</span>';
      
      // Test API call with token
      const testResponse = await fetch('https://api.spotify.com/v1/tracks/6Sq7ltF9Qa7SNqBwlj0tbn', {
        headers: { "Authorization": "Bearer " + token }
      });
      
      if (testResponse.ok) {
        const trackData = await testResponse.json();
        log(`‚úÖ API test successful - Track: ${trackData.name} by ${trackData.artists[0].name}`, 'pass');
        results.innerHTML += '<br><span class="pass">‚úÖ API call successful</span>';
      } else {
        log(`‚ùå API test failed - Status: ${testResponse.status}`, 'fail');
        results.innerHTML += '<br><span class="fail">‚ùå API call failed</span>';
      }
    } else {
      log('‚ùå Failed to obtain Spotify token', 'fail');
      results.innerHTML = '<span class="fail">‚ùå Token acquisition failed</span>';
    }
  } catch (error) {
    log(`‚ùå Error testing Spotify token: ${error.message}`, 'fail');
    results.innerHTML = '<span class="fail">‚ùå Token test error</span>';
  }
}

// Test 4: Test Plotly Hover Events
function testHoverEvents() {
  log('üîç Testing Plotly hover events...');
  const results = document.getElementById('hoverResults');
  const iframe = document.getElementById('chartFrame');
  
  try {
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    
    // Check if Plotly is available
    const checkPlotly = setInterval(() => {
      if (iframe.contentWindow.Plotly && iframeDoc.querySelector('#plot')) {
        clearInterval(checkPlotly);
        
        const plotDiv = iframeDoc.querySelector('#plot');
        log('‚úÖ Plotly and plot div found', 'pass');
        
        // Try to attach hover event
        try {
          plotDiv.on('plotly_hover', function(eventData) {
            log('‚úÖ Hover event triggered!', 'pass');
            log(`Event data: ${JSON.stringify(eventData.points[0].customdata)}`, 'info');
          });
          log('‚úÖ Hover event listener attached', 'pass');
          results.innerHTML = '<span class="pass">‚úÖ Hover events ready</span>';
        } catch (error) {
          log(`‚ùå Error attaching hover event: ${error.message}`, 'fail');
          results.innerHTML = '<span class="fail">‚ùå Hover event error</span>';
        }
      }
    }, 500);
    
    // Timeout after 10 seconds
    setTimeout(() => {
      clearInterval(checkPlotly);
      if (!results.innerHTML.includes('‚úÖ')) {
        log('‚ùå Timeout waiting for Plotly to load', 'fail');
        results.innerHTML = '<span class="fail">‚ùå Plotly load timeout</span>';
      }
    }, 10000);
    
  } catch (error) {
    log(`‚ùå Error testing hover events: ${error.message}`, 'fail');
    results.innerHTML = '<span class="fail">‚ùå Hover test error</span>';
  }
}

// Test 5: Test Complete Integration
async function testFullIntegration() {
  log('üîç Testing complete integration...');
  const results = document.getElementById('integrationResults');
  
  try {
    // Step 1: Check token
    const token = await getSpotifyToken();
    if (!token) {
      log('‚ùå Integration test failed: No token', 'fail');
      results.innerHTML = '<span class="fail">‚ùå No token available</span>';
      return;
    }
    
    // Step 2: Test with a known track ID
    const testTrackId = '6Sq7ltF9Qa7SNqBwlj0tbn'; // Bad Bunny - Dakiti
    const response = await fetch(`https://api.spotify.com/v1/tracks/${testTrackId}`, {
      headers: { "Authorization": "Bearer " + token }
    });
    
    if (response.ok) {
      const trackData = await response.json();
      log(`‚úÖ Full integration test successful!`, 'pass');
      log(`Track: ${trackData.name} by ${trackData.artists[0].name}`, 'info');
      log(`Preview URL: ${trackData.preview_url ? 'Available' : 'Not available'}`, 'info');
      results.innerHTML = '<span class="pass">‚úÖ Full integration working</span>';
    } else {
      log(`‚ùå Integration test failed - API response: ${response.status}`, 'fail');
      results.innerHTML = '<span class="fail">‚ùå API call failed</span>';
    }
    
  } catch (error) {
    log(`‚ùå Integration test error: ${error.message}`, 'fail');
    results.innerHTML = '<span class="fail">‚ùå Integration error</span>';
  }
}

// Auto-run basic tests on load
window.onload = function() {
  log('üöÄ Starting Spotify Integration Tests...');
  setTimeout(testChartLoad, 1000);
  setTimeout(testSpotifyToken, 2000);
};

</script>

</body>
</html>
