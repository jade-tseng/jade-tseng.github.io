<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Artist Bubble Chart with Spotify Preview</title>
  <style>
    iframe { width: 100%; height: 90vh; border: none; }
    audio { position: fixed; bottom: 10px; left: 10px; }
  </style>
</head>
<body>

<!-- Load the updated chart -->
<iframe id="chartFrame" src="music-chart.html"></iframe>

<!-- Audio player -->
<audio id="player" controls style="display:none;"></audio>

<script>
  // Spotify API credentials
  const CLIENT_ID = '44dd5c1f9fa4405c92e27a9fa236e124';
  const CLIENT_SECRET = '85ab203ffe05451c8e81cc66e3ef1087';
  
  let spotifyToken = null;
  let tokenExpiry = null;

  // Get Spotify access token using Client Credentials Flow
  async function getSpotifyToken() {
    if (spotifyToken && tokenExpiry && Date.now() < tokenExpiry) {
      return spotifyToken;
    }

    try {
      const response = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Authorization': 'Basic ' + btoa(CLIENT_ID + ':' + CLIENT_SECRET)
        },
        body: 'grant_type=client_credentials'
      });

      if (!response.ok) {
        throw new Error('Failed to get Spotify token');
      }

      const data = await response.json();
      spotifyToken = data.access_token;
      tokenExpiry = Date.now() + (data.expires_in * 1000) - 60000; // Subtract 1 minute for safety
      
      console.log('‚úÖ Spotify token obtained successfully');
      return spotifyToken;
    } catch (error) {
      console.error('‚ùå Error getting Spotify token:', error);
      return null;
    }
  }

  const iframe = document.getElementById('chartFrame');
  const player = document.getElementById('player');

  iframe.onload = function () {
    try {
      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

      // Wait until Plotly is ready inside the iframe
      const checkPlotlyReady = setInterval(() => {
        if (iframe.contentWindow.Plotly && iframeDoc.querySelector('#plot')) {
          clearInterval(checkPlotlyReady);
          console.log('üéµ Plotly chart loaded, hover events ready!');

          const plotDiv = iframeDoc.querySelector('#plot');

          plotDiv.on('plotly_hover', async function(eventData) {
            const trackId = eventData.points[0].customdata; 
            if (!trackId) return;

            console.log('üéß Hovering over track:', trackId);

            try {
              const token = await getSpotifyToken();
              if (!token) {
                console.error('‚ùå No Spotify token available');
                return;
              }

              let res = await fetch(`https://api.spotify.com/v1/tracks/${trackId}`, {
                headers: { "Authorization": "Bearer " + token }
              });
              let trackData = await res.json();

              if (trackData.preview_url) {
                player.src = trackData.preview_url;
                player.style.display = "block";
                player.play();
              } else {
                console.warn("No preview available for this track");
              }
            } catch (err) {
              console.error("Error fetching track", err);
            }
          });

        }
      }, 500);
    } catch (err) {
      console.error("Could not inject into iframe:", err);
    }
  };
</script>

</body>
</html>
