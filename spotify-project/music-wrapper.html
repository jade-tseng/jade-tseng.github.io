<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Artist Bubble Chart with Spotify Preview</title>
  <style>
    iframe { width: 100%; height: 90vh; border: none; }
    audio { position: fixed; bottom: 10px; left: 10px; }
  </style>
</head>
<body>

<!-- Load the untouched chart -->
<iframe id="chartFrame" src="artist_bubble_chart.html"></iframe>

<!-- Audio player -->
<audio id="player" controls style="display:none;"></audio>

<script>
  const SPOTIFY_TOKEN = "YOUR_SPOTIFY_ACCESS_TOKEN"; // Client Credentials Flow

  const iframe = document.getElementById('chartFrame');
  const player = document.getElementById('player');

  iframe.onload = function () {
    try {
      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

      // Wait until Plotly is ready inside the iframe
      const checkPlotlyReady = setInterval(() => {
        if (iframe.contentWindow.Plotly && iframeDoc.querySelector('#plot')) {
          clearInterval(checkPlotlyReady);

          const plotDiv = iframeDoc.querySelector('#plot');

          plotDiv.on('plotly_hover', async function(eventData) {
            const trackId = eventData.points[0].customdata; 
            if (!trackId) return;

            try {
              let res = await fetch(`https://api.spotify.com/v1/tracks/${trackId}`, {
                headers: { "Authorization": "Bearer " + SPOTIFY_TOKEN }
              });
              let trackData = await res.json();

              if (trackData.preview_url) {
                player.src = trackData.preview_url;
                player.style.display = "block";
                player.play();
              } else {
                console.warn("No preview available for this track");
              }
            } catch (err) {
              console.error("Error fetching track", err);
            }
          });

        }
      }, 500);
    } catch (err) {
      console.error("Could not inject into iframe:", err);
    }
  };
</script>

</body>
</html>

