<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Debug Spotify Integration</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
    iframe { width: 100%; height: 400px; border: 2px solid red; }
    .log { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; }
  </style>
</head>
<body>

<h1>üêõ Debug Spotify Integration</h1>

<div class="debug-section">
  <h2>Step 1: Test Direct Chart Load</h2>
  <p>This should load music-chart.html directly:</p>
  <iframe id="directChart" src="music-chart.html"></iframe>
  <div class="log" id="directLog">Loading...</div>
</div>

<div class="debug-section">
  <h2>Step 2: Test Wrapper Logic</h2>
  <button onclick="testWrapperLogic()">Test Wrapper Logic</button>
  <div class="log" id="wrapperLog">Click button to test...</div>
</div>

<div class="debug-section">
  <h2>Step 3: Test Spotify API</h2>
  <button onclick="testSpotifyAPI()">Test Spotify API</button>
  <div class="log" id="spotifyLog">Click button to test...</div>
</div>

<script>
// Same credentials as music-wrapper
const CLIENT_ID = '44dd5c1f9fa4405c92e27a9fa236e124';
const CLIENT_SECRET = '85ab203ffe05451c8e81cc66e3ef1087';

function log(elementId, message) {
  document.getElementById(elementId).innerHTML += `[${new Date().toLocaleTimeString()}] ${message}<br>`;
  console.log(message);
}

// Test 1: Direct chart load
document.getElementById('directChart').onload = function() {
  log('directLog', '‚úÖ music-chart.html loaded successfully');
  
  const iframe = document.getElementById('directChart');
  try {
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    if (iframeDoc) {
      log('directLog', '‚úÖ Can access iframe content');
      
      const plotDiv = iframeDoc.querySelector('#plot');
      if (plotDiv) {
        log('directLog', '‚úÖ Found #plot div in chart');
        
        // Check if Plotly is loaded
        setTimeout(() => {
          if (iframe.contentWindow.Plotly) {
            log('directLog', '‚úÖ Plotly is available in iframe');
            
            // Check for customdata in the page source
            const scripts = iframeDoc.querySelectorAll('script');
            let hasCustomData = false;
            scripts.forEach(script => {
              if (script.textContent.includes('customdata')) {
                hasCustomData = true;
              }
            });
            
            if (hasCustomData) {
              log('directLog', '‚úÖ Found customdata in chart scripts');
            } else {
              log('directLog', '‚ùå No customdata found in chart scripts');
            }
            
          } else {
            log('directLog', '‚ùå Plotly not available in iframe');
          }
        }, 2000);
        
      } else {
        log('directLog', '‚ùå No #plot div found in chart');
      }
    } else {
      log('directLog', '‚ùå Cannot access iframe content (CORS issue?)');
    }
  } catch (error) {
    log('directLog', `‚ùå Error accessing iframe: ${error.message}`);
  }
};

document.getElementById('directChart').onerror = function() {
  log('directLog', '‚ùå Failed to load music-chart.html');
};

// Test 2: Wrapper logic simulation
function testWrapperLogic() {
  log('wrapperLog', 'üîç Testing wrapper logic...');
  
  const iframe = document.getElementById('directChart');
  
  try {
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    
    // Simulate the wrapper's checkPlotlyReady logic
    const checkPlotlyReady = setInterval(() => {
      if (iframe.contentWindow.Plotly && iframeDoc.querySelector('#plot')) {
        clearInterval(checkPlotlyReady);
        log('wrapperLog', '‚úÖ Plotly chart loaded, hover events ready!');
        
        const plotDiv = iframeDoc.querySelector('#plot');
        
        try {
          // Try to attach hover event (same as wrapper)
          plotDiv.on('plotly_hover', async function(eventData) {
            log('wrapperLog', 'üéß Hover event triggered!');
            log('wrapperLog', `Track ID: ${eventData.points[0].customdata}`);
            
            // Test the full flow
            if (eventData.points[0].customdata) {
              log('wrapperLog', '‚úÖ Track ID found in hover event');
              testSpotifyTrack(eventData.points[0].customdata);
            } else {
              log('wrapperLog', '‚ùå No track ID in hover event');
            }
          });
          
          log('wrapperLog', '‚úÖ Hover event listener attached successfully');
          log('wrapperLog', 'üí° Now try hovering over a bubble in the chart above');
          
        } catch (error) {
          log('wrapperLog', `‚ùå Error attaching hover event: ${error.message}`);
        }
      }
    }, 500);
    
    // Timeout after 10 seconds
    setTimeout(() => {
      clearInterval(checkPlotlyReady);
      log('wrapperLog', '‚è∞ Timeout waiting for Plotly to load');
    }, 10000);
    
  } catch (error) {
    log('wrapperLog', `‚ùå Error in wrapper logic test: ${error.message}`);
  }
}

// Test 3: Spotify API
async function testSpotifyAPI() {
  log('spotifyLog', 'üîç Testing Spotify API...');
  
  try {
    // Get token
    const response = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': 'Basic ' + btoa(CLIENT_ID + ':' + CLIENT_SECRET)
      },
      body: 'grant_type=client_credentials'
    });
    
    if (!response.ok) {
      log('spotifyLog', `‚ùå Token request failed: ${response.status}`);
      return;
    }
    
    const tokenData = await response.json();
    log('spotifyLog', '‚úÖ Got Spotify token successfully');
    
    // Test API call with Bad Bunny track
    const trackId = '6Sq7ltF9Qa7SNqBwlj0tbn';
    const trackResponse = await fetch(`https://api.spotify.com/v1/tracks/${trackId}`, {
      headers: { "Authorization": "Bearer " + tokenData.access_token }
    });
    
    if (trackResponse.ok) {
      const trackData = await trackResponse.json();
      log('spotifyLog', `‚úÖ Track API call successful`);
      log('spotifyLog', `Track: ${trackData.name} by ${trackData.artists[0].name}`);
      log('spotifyLog', `Preview URL: ${trackData.preview_url ? 'Available' : 'Not available'}`);
      
      if (trackData.preview_url) {
        log('spotifyLog', '‚úÖ Preview URL found - audio should work');
      } else {
        log('spotifyLog', '‚ö†Ô∏è No preview URL - this track cannot be played');
      }
    } else {
      log('spotifyLog', `‚ùå Track API call failed: ${trackResponse.status}`);
    }
    
  } catch (error) {
    log('spotifyLog', `‚ùå Spotify API test error: ${error.message}`);
  }
}

async function testSpotifyTrack(trackId) {
  log('wrapperLog', `üéµ Testing Spotify track: ${trackId}`);
  
  try {
    // This simulates what the wrapper does
    const tokenResponse = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': 'Basic ' + btoa(CLIENT_ID + ':' + CLIENT_SECRET)
      },
      body: 'grant_type=client_credentials'
    });
    
    const tokenData = await tokenResponse.json();
    
    const trackResponse = await fetch(`https://api.spotify.com/v1/tracks/${trackId}`, {
      headers: { "Authorization": "Bearer " + tokenData.access_token }
    });
    
    if (trackResponse.ok) {
      const trackData = await trackResponse.json();
      log('wrapperLog', `‚úÖ Successfully fetched: ${trackData.name}`);
      
      if (trackData.preview_url) {
        log('wrapperLog', '‚úÖ Preview URL available - would play audio now');
      } else {
        log('wrapperLog', '‚ö†Ô∏è No preview URL for this track');
      }
    } else {
      log('wrapperLog', `‚ùå Failed to fetch track data: ${trackResponse.status}`);
    }
    
  } catch (error) {
    log('wrapperLog', `‚ùå Error testing track: ${error.message}`);
  }
}

</script>

</body>
</html>
